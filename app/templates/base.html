<!DOCTYPE html>
<html lang="ru">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<head>
    {% if title %}
        <title>{{ title }} - 汉语中心</title>
    {% else %}
        <title>汉语中心</title>
    {% endif %}
</head>
{{ bootstrap.load_css() }}
<link rel="stylesheet" href="{{ url_for('static',filename='styles.css') }}">
{{ moment.include_moment() }}
{{ moment.locale(auto_detect=True) }}
<header class="header container d-flex flex-wrap align-items-center justify-content-md-between py-3 mb-4">
    <div class="col-md-3 mb-2 mb-md-0">
        <a href="/" class="d-inline-flex link-body-emphasis text-decoration-none">
            <svg class="bi" width="40" height="32" role="img" aria-label="Bootstrap">
                <use xlink:href="#bootstrap"></use>
            </svg>
        </a>
    </div>

    <ul class="nav col-12 col-md-auto mb-2 justify-content-center mb-md-0">
        <li><a href="/index" class="nav-link px-2">Дом</a></li>
        {% if current_user.is_authenticated %}
            <li><a href="/user/{{ current_user.id }}" class="nav-link px-2">Мой профиль</a></li>
        {% endif %}
        <li><a href="/words" class="nav-link px-2 link-dark">Слова</a></li>
    </ul>
    <div class="col-md-3 text-end" style="display: flex; flex-direction: row; align-items: center;">
        <div class="form-check form-switch" style="padding-right: 1em;">
            <input class="form-check-input" type="checkbox" id="darkSwitch" onchange="toggleTheme()" data-theme-toggle>
            <label class="form-check-label" for="darkSwitch">Темная тема</label>
        </div>
        {% if current_user.is_anonymous %}
            <a class="btn btn-outline-primary me-2" href="{{ url_for('login') }}">Login</a>
        {% else %}
            <a class="btn btn-outline-primary me-2" href="{{ url_for('logout') }}"> {{ current_user.username }}
                <br>
                Log-out</a>
        {% endif %}
    </div>
</header>


<body class="d-flex flex-column h-100">
{% with messages = get_flashed_messages() %}
    {% if messages %}
        <div class="container">
            <ul>
                {% for message in messages %}
                    <li>{{ message }}</li>
                {% endfor %}
            </ul>
        </div>
    {% endif %}
{% endwith %}
{% block content %}{% endblock %}
<div class="modal fade" id="modal">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Stroke order</h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body"></div>
        </div>
    </div>
</div>
</body>
<footer class="footer mt-auto py-3 d-flex container">
    <div class="container">
        <span>Тимофеев Кирилл, 2024</span>
    </div>
</footer>
</html>
{% block scripts %}
{% endblock %}
<script>
    function getTheme() {
        return localStorage.getItem('theme') || 'light';
    }

    function toggleTheme() {
        const body = document.body;
        const checkbox = document.getElementById('darkSwitch');
        if (body.classList.contains('dark-theme')) {
            body.classList.remove('dark-theme');
            localStorage.setItem('theme', 'light');
            checkbox.checked = false;
        } else {
            body.classList.add('dark-theme');
            localStorage.setItem('theme', 'dark');
            checkbox.checked = true;
        }
    }

    window.addEventListener('DOMContentLoaded', function () {
        const theme = getTheme();
        if (theme === 'dark') {
            document.body.classList.add('dark-theme');
            document.getElementById('darkSwitch').checked = true;
        }
    })
</script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/hanzi-writer@3.5/dist/hanzi-writer.min.js"></script>
<script>
    {% if current_user.is_authenticated %}
        window.addEventListener('DOMContentLoaded', function () {
            var accuracyCells = document.querySelectorAll('.percent');
            accuracyCells.forEach(function (cell) {
                var accuracy = parseInt(cell.textContent);
                if (accuracy >= 80) {
                    cell.classList.add('green');
                } else if (accuracy >= 60) {
                    cell.classList.add('yellow');
                } else if (accuracy >= 20) {
                    cell.classList.add('red')
                }
            })
        })
    {% endif %}
</script>
<script>
    window.addEventListener('DOMContentLoaded', function () {
        const toggleButtons = document.querySelectorAll('.toggle-children');
        console.log(toggleButtons)
        toggleButtons.forEach(button => {
            button.addEventListener('click', () => {
                const parent = button.parentElement.parentElement;
                const children = parent.nextElementSibling;
                children.style.display = children.style.display === 'none' ? 'block' : 'none';
                button.textContent = children.style.display === 'none' ? '↓' : '↑'
            });
        });

        const rowItems = document.querySelectorAll('div.row-item');
        rowItems.forEach(rowItem => {
            const chineseElement = rowItem.querySelector('.chinese');
            if (chineseElement) {
                rowItem.addEventListener('click', (event) => {
                    if (!event.target.closest('.toggle-children')) {
                        const answer = chineseElement.textContent.trim();
                        showModal(answer);
                    }
                });
            }
        });
    });

    function showModal(answer) {
        var modalBody = document.querySelector('.modal-body');
        modalBody.style.display = 'flex';
        modalBody.style.flexDirection = 'column';
        modalBody.style.flexWrap = 'nowrap';
        modalBody.style.justifyContent = 'center';

        modalBody.innerHTML = '';
        const isDarkMode = localStorage.getItem('theme') === 'dark';
        const strokeColor = isDarkMode ? '#ffffff' : '#333333';
        const outlineColor = isDarkMode ? '#333333' : '#ffffff';

        var characterContainer = document.createElement('div');
        characterContainer.classList.add('character-container');
        modalBody.appendChild(characterContainer);

        var answers = answer.split('');
        answers.forEach(function (char, index) {
            var charTargetId = 'character-target-' + (index + 1);
            var charDiv = document.createElement('div');
            charDiv.id = charTargetId;
            charDiv.style.width = '100px';
            charDiv.style.height = '100px';
            characterContainer.appendChild(charDiv);


            var writer = HanziWriter.create(charTargetId, char, {
                width: 100,
                height: 100,
                padding: 5,
                strokeAnimationSpeed: 1.5,
                delayBetweenStrokes: 20,
                strokeColor: strokeColor,
                outlineColor: outlineColor,
            });
            charDiv.addEventListener('click', function () {
                writer.animateCharacter();
            });
        });

        fetchTranslation(answer).then(function (data) {
            var pronounciationDiv = document.createElement('div');
            pronounciationDiv.textContent = data.pronunciation;
            pronounciationDiv.classList.add('character-container');
            modalBody.appendChild(pronounciationDiv);

            var translateDiv = document.createElement('div');
            translateDiv.textContent = data.translation;
            translateDiv.classList.add('character-container');
            modalBody.appendChild(translateDiv);
        });


        $('#modal').modal('show');
    }

    function fetchTranslation(char) {
        return fetch('/api/translate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({'char': char})
        })
            .then(response => response.json())
            .catch(error => console.error('Ошибка:', error));
    }
</script>